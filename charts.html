<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS Charts</title>
    <link rel="icon" type="image/jpeg" href="favicon.jpg?v=2">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #131722;
            color: #d1d4dc;
        }

        .header {
            background: #1e222d;
            padding: 15px 20px;
            border-bottom: 1px solid #2a2e39;
        }

        .header h1 {
            margin: 0;
            color: #fff;
            display: inline;
        }

        .nav-links {
            float: right;
        }

        .nav-links a {
            text-decoration: none;
            color: white;
            background: #2962ff;
            padding: 8px 16px;
            margin-left: 10px;
            border-radius: 4px;
        }

        .nav-links a.active {
            background: #f23645;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 280px;
            background: #1e222d;
            padding: 15px;
            overflow-y: auto;
        }

        .filter-btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }

        .filter-btn.green {
            background: #089981;
        }

        .filter-btn.blue {
            background: #2962ff;
        }

        .filter-btn.yellow {
            background: #f7931a;
        }

        .filter-btn.red {
            background: #f23645;
        }

        .filter-btn.gray {
            background: #363c4e;
        }

        #searchStock {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #2a2e39;
            border: 1px solid #363c4e;
            color: #fff;
            border-radius: 4px;
        }

        .stock-item {
            background: #2a2e39;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .stock-item:hover,
        .stock-item.active {
            background: #363c4e;
            border-left-color: #2962ff;
        }

        .stock-rs {
            float: right;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .rs-high {
            background: #089981;
            color: white;
        }

        .rs-medium {
            background: #f7931a;
            color: white;
        }

        .rs-low {
            background: #f23645;
            color: white;
        }

        .chart-area {
            flex: 1;
            padding: 15px;
        }

        .chart-header {
            background: #1e222d;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .rs-score-display {
            font-size: 1.5rem;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 4px;
        }

        #chartBox {
            background: #1e222d;
            padding: 20px;
            border-radius: 4px;
            height: 400px;
        }

        canvas {
            max-height: 100%;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat {
            background: #1e222d;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #787b86;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>ðŸ“ˆ Saudi Market RS</h1>
        <div class="nav-links">
            <a href="index.html">Table</a>
            <a href="charts.html" class="active">Charts</a>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h3 style="color:#787b86; margin-top:0;">FILTERS</h3>
            <button class="filter-btn green" onclick="filterStocks(80,100)">Top (80+)</button>
            <button class="filter-btn blue" onclick="filterStocks(50,79)">Above Avg</button>
            <button class="filter-btn yellow" onclick="filterStocks(20,49)">Below Avg</button>
            <button class="filter-btn red" onclick="filterStocks(0,19)">Weak</button>
            <button class="filter-btn gray" onclick="filterStocks(0,100)">All</button>
            <input type="text" id="searchStock" placeholder="Search..." oninput="searchStocks(this.value)">
            <div id="stockList"></div>
        </div>

        <div class="chart-area">
            <div class="chart-header">
                <div>
                    <div id="chartTitle" style="font-size:1.2rem; font-weight:600; color:#fff;">Select a stock</div>
                    <div id="chartInfo" style="color:#787b86; font-size:0.9rem;">-</div>
                </div>
                <div id="rsScore" class="rs-score-display rs-medium">--</div>
            </div>

            <div id="chartBox">
                <canvas id="myChart"></canvas>
            </div>

            <div class="stats" id="statsPanel"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        let allStocks = [];
        let filteredStocks = [];
        let myChart = null;

        Papa.parse('saudiexchange_rs_analysis.csv', {
            download: true,
            header: true,
            complete: function (results) {
                allStocks = results.data.filter(d => d.Company && d.RS);
                // Sort by RS descending initially
                allStocks.sort((a, b) => parseFloat(b.RS) - parseFloat(a.RS));
                filteredStocks = [...allStocks];
                renderList();
                if (allStocks.length > 0) {
                    loadStock(allStocks[0], null);
                }
            }
        });

        function renderList() {
            const html = filteredStocks.map((s, i) => {
                const rs = parseFloat(s.RS);
                let c = 'rs-low';
                if (rs >= 80) c = 'rs-high';
                else if (rs >= 50) c = 'rs-medium';
                return `<div class="stock-item" data-i="${i}">
                    <div class="stock-rs ${c}">${s.RS}</div>
                    <div style="font-weight:600; color:#fff;">${s.Company}</div>
                    <div style="font-size:0.85rem; color:#787b86;">${s.Symbol}</div>
                </div>`;
            }).join('');
            document.getElementById('stockList').innerHTML = html || '<p style="color:#787b86;">No stocks</p>';

            document.querySelectorAll('.stock-item').forEach(item => {
                item.addEventListener('click', function () {
                    const i = parseInt(this.getAttribute('data-i'));
                    loadStock(filteredStocks[i], this);
                });
            });
        }

        function filterStocks(min, max) {
            filteredStocks = allStocks.filter(s => {
                const rs = parseFloat(s.RS);
                return rs >= min && rs <= max;
            });
            // Sort by RS descending
            filteredStocks.sort((a, b) => parseFloat(b.RS) - parseFloat(a.RS));
            renderList();
        }

        function searchStocks(q) {
            const query = q.toLowerCase();
            filteredStocks = allStocks.filter(s =>
                s.Company.toLowerCase().includes(query) ||
                (s.Symbol && s.Symbol.toLowerCase().includes(query))
            );
            // Sort by RS descending
            filteredStocks.sort((a, b) => parseFloat(b.RS) - parseFloat(a.RS));
            renderList();
        }

        function loadStock(stock, el) {
            document.getElementById('chartTitle').textContent = stock.Company;
            document.getElementById('chartInfo').textContent = `Symbol: ${stock.Symbol || 'N/A'}`;

            const rs = parseFloat(stock.RS);
            const rsEl = document.getElementById('rsScore');
            rsEl.textContent = `RS: ${stock.RS}`;
            rsEl.className = 'rs-score-display ' + (rs >= 80 ? 'rs-high' : rs >= 50 ? 'rs-medium' : 'rs-low');

            document.getElementById('statsPanel').innerHTML = `
                <div class="stat"><div class="stat-label">3M</div><div class="stat-value">${stock.RS_3Months || '-'}</div></div>
                <div class="stat"><div class="stat-label">6M</div><div class="stat-value">${stock.RS_6Months || '-'}</div></div>
                <div class="stat"><div class="stat-label">9M</div><div class="stat-value">${stock.RS_9Months || '-'}</div></div>
                <div class="stat"><div class="stat-label">1Y</div><div class="stat-value">${stock.RS_1Year || '-'}</div></div>
            `;

            createChart(stock);

            document.querySelectorAll('.stock-item').forEach(i => i.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        function createChart(stock) {
            if (myChart) myChart.destroy();

            const labels = [];
            const data = [];

            if (stock.RS_1Year) { labels.push('1Y'); data.push(parseFloat(stock.RS_1Year)); }
            if (stock.RS_9Months) { labels.push('9M'); data.push(parseFloat(stock.RS_9Months)); }
            if (stock.RS_6Months) { labels.push('6M'); data.push(parseFloat(stock.RS_6Months)); }
            if (stock.RS_3Months) { labels.push('3M'); data.push(parseFloat(stock.RS_3Months)); }
            labels.push('Now');
            data.push(parseFloat(stock.RS));

            const ctx = document.getElementById('myChart');
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(41, 98, 255, 0.5)');
            gradient.addColorStop(1, 'rgba(41, 98, 255, 0.0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#2962ff',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#2962ff',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e222d',
                            titleColor: '#fff',
                            bodyColor: '#d1d4dc',
                            borderColor: '#2962ff',
                            borderWidth: 2,
                            callbacks: {
                                label: (c) => 'RS: ' + c.parsed.y
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#2a2e39' },
                            ticks: { color: '#787b86' }
                        },
                        x: {
                            grid: { color: '#2a2e39' },
                            ticks: { color: '#787b86', font: { weight: 'bold' } }
                        }
                    }
                }
            });
        }
    </script>

</body>

</html>