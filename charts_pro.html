<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saudi Market RS - Professional</title>
    <link rel="icon" type="image/jpeg" href="favicon.jpg?v=2">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #131722;
            --panel-color: #1e222d;
            --border-color: #2a2e39;
            --text-color: #d1d4dc;
            --accent-color: #2962ff;
            --up-color: #089981;
            --down-color: #f23645;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        .layout {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: var(--panel-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
            color: #fff;
        }

        .search-box {
            padding: 12px;
            background: var(--border-color);
            border: none;
            width: 100%;
            box-sizing: border-box;
            color: #fff;
            margin-top: 10px;
            border-radius: 4px;
            outline: none;
        }

        .search-box:focus {
            outline: 1px solid var(--accent-color);
        }

        .filter-group {
            padding: 10px 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: var(--border-color);
            border: none;
            color: var(--text-color);
            padding: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }

        .filter-chip:hover {
            background: #363a45;
        }

        .filter-chip.active {
            background: var(--accent-color);
            color: #fff;
        }

        .symbol-list {
            flex: 1;
            overflow-y: auto;
        }

        .symbol-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
        }

        .symbol-item:hover {
            background: #2a2e39;
        }

        .symbol-item.active {
            background: #2a2e39;
            border-left: 4px solid var(--accent-color);
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
        }

        .symbol-ticker {
            font-weight: bold;
            color: #fff;
        }

        .symbol-name {
            font-size: 12px;
            color: #787b86;
            margin-top: 4px;
        }

        .rs-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            min-width: 30px;
            text-align: center;
        }

        .rs-high {
            background: rgba(8, 153, 129, 0.2);
            color: #089981;
        }

        .rs-mid {
            background: rgba(247, 147, 26, 0.2);
            color: #f7931a;
        }

        .rs-low {
            background: rgba(242, 54, 69, 0.2);
            color: #f23645;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chart-toolbar {
            padding: 12px 20px;
            background: var(--panel-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-symbol {
            display: flex;
            flex-direction: column;
        }

        .current-ticker {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }

        .current-name {
            font-size: 14px;
            color: #787b86;
        }

        .toolbar-stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            text-align: right;
        }

        .stat-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-color);
        }

        #chartContainer {
            flex: 1;
            width: 100%;
            position: relative;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #787b86;
            text-align: center;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: #363c4e;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #50566e;
        }
    </style>
</head>

<body>

    <div class="layout">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ðŸ“Š Market Tracker</h2>
                <input type="text" class="search-box" placeholder="Search Symbol or Company..." id="searchInput">
            </div>
            <div class="filter-group">
                <button class="filter-chip active" data-filter="all">All</button>
                <button class="filter-chip" data-filter="high">Strong (80+)</button>
                <button class="filter-chip" data-filter="mid">Avg (50-79)</button>
                <button class="filter-chip" data-filter="low">Weak (<50)< /button>
            </div>
            <div class="symbol-list" id="symbolList">
                <!-- Items injected here -->
            </div>
        </div>

        <div class="main-content">
            <div class="chart-toolbar">
                <div class="toolbar-symbol">
                    <span class="current-ticker" id="displayTicker">SELECT A STOCK</span>
                    <span class="current-name" id="displayName">--</span>
                </div>
                <div class="toolbar-stats">
                    <div class="stat-box">
                        <div class="stat-label">Current RS</div>
                        <div class="stat-value" id="displayRS">--</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">3 Months Ago</div>
                        <div class="stat-value" id="displayRS_3M">--</div>
                    </div>
                </div>
            </div>
            <div id="chartContainer">
                <div class="empty-state">Select a stock to view RS History</div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let mainSeries;
        let dataMap = [];
        let currentFilter = 'all';

        // Initialize Chart immediately
        const container = document.getElementById('chartContainer');
        chart = LightweightCharts.createChart(container, {
            layout: {
                background: { color: '#131722' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2a2e39' },
                horzLines: { color: '#2a2e39' },
            },
            rightPriceScale: {
                borderVisible: false,
                scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            timeScale: {
                borderVisible: false,
            },
            crosshair: {
                vertLine: { labelVisible: false },
            },
        });

        mainSeries = chart.addAreaSeries({
            topColor: 'rgba(41, 98, 255, 0.4)',
            bottomColor: 'rgba(41, 98, 255, 0.0)',
            lineColor: '#2962ff',
            lineWidth: 3,
        });

        window.addEventListener('resize', () => {
            chart.resize(container.clientWidth, container.clientHeight);
        });

        // Load Data
        Papa.parse('saudiexchange_rs_analysis.csv', {
            download: true,
            header: true,
            complete: function (results) {
                dataMap = results.data
                    .filter(r => r.Symbol && r.RS)
                    .map(r => ({
                        ...r,
                        rsVal: parseFloat(r.RS),
                        rs3m: parseFloat(r.RS_3Months || 0),
                        rs6m: parseFloat(r.RS_6Months || 0),
                        rs9m: parseFloat(r.RS_9Months || 0),
                        rs1y: parseFloat(r.RS_1Year || 0),
                    }))
                    .sort((a, b) => b.rsVal - a.rsVal); // Sort by RS DESC

                renderList();

                // Auto-select first
                if (dataMap.length > 0) loadStock(dataMap[0]);
            }
        });

        function renderList(searchVal = '') {
            const listEl = document.getElementById('symbolList');
            listEl.innerHTML = '';

            const filtered = dataMap.filter(item => {
                const matchesSearch = item.Company.toLowerCase().includes(searchVal.toLowerCase()) ||
                    item.Symbol.includes(searchVal);

                let matchesFilter = true;
                if (currentFilter === 'high') matchesFilter = item.rsVal >= 80;
                else if (currentFilter === 'mid') matchesFilter = item.rsVal >= 50 && item.rsVal < 79;
                else if (currentFilter === 'low') matchesFilter = item.rsVal < 50;

                return matchesSearch && matchesFilter;
            });

            filtered.forEach(item => {
                const el = document.createElement('div');
                el.className = 'symbol-item';

                let badgeClass = 'rs-low';
                if (item.rsVal >= 80) badgeClass = 'rs-high';
                else if (item.rsVal >= 50) badgeClass = 'rs-mid';

                el.innerHTML = `
                <div class="symbol-info">
                    <span class="symbol-ticker">${item.Symbol}</span>
                    <span class="symbol-name">${item.Company}</span>
                </div>
                <div class="rs-badge ${badgeClass}">${item.rsVal}</div>
            `;
                el.onclick = () => {
                    document.querySelectorAll('.symbol-item').forEach(d => d.classList.remove('active'));
                    el.classList.add('active');
                    loadStock(item);
                };
                listEl.appendChild(el);
            });
        }

        function loadStock(item) {


            document.getElementById('displayTicker').innerText = item.Symbol;
            document.getElementById('displayName').innerText = item.Company;
            document.getElementById('displayRS').innerText = item.rsVal;
            document.getElementById('displayRS_3M').innerText = item.rs3m;

            // Color stats
            document.getElementById('displayRS').style.color = item.rsVal >= 80 ? '#089981' : item.rsVal >= 50 ? '#f7931a' : '#f23645';

            // Prepare chart data (Fake timeline for visualization: 1Y ago, 9M ago, etc.)
            // Since Lightweight Charts needs Dates, we'll fake dates relative to today
            const now = new Date();
            const d = (monthsAgo) => {
                const date = new Date(now);
                date.setMonth(date.getMonth() - monthsAgo);
                return date.toISOString().split('T')[0];
            };

            const chartData = [
                { time: d(12), value: item.rs1y || item.rs9m }, // Fallback if missing
                { time: d(9), value: item.rs9m },
                { time: d(6), value: item.rs6m },
                { time: d(3), value: item.rs3m },
                { time: d(0), value: item.rsVal },
            ].sort((a, b) => new Date(a.time) - new Date(b.time));

            mainSeries.setData(chartData);
            chart.timeScale().fitContent();
        }

        // Event Listeners
        document.getElementById('searchInput').addEventListener('input', (e) => renderList(e.target.value));

        document.querySelectorAll('.filter-chip').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderList(document.getElementById('searchInput').value);
            };
        });

    </script>

</body>

</html>