//@version=5
indicator(title='Saudi RS Rating (Percentile)', shorttitle='Saudi RS%', overlay=true, max_bars_back = 253)

// --- CONFIGURATION ---
comparativeTickerId = 'TADAWUL:TASI'

// --- INPUTS ---
hideRSRat   = input(false, title='Hide Rating', group = 'RS Rating')
ratingOnly  = input(false, title='Rating Only', group = 'RS Rating')
colorRS     = input(color.rgb(0, 0, 255,0), title = 'Color', group = 'RS Line')
lineTicker  = input('TADAWUL:TASI', title='Comparative Symbol', group = 'Shape & Offset')
IndexValue  = input(11500, title='Approximate TASI Value', group = 'Shape & Offset')
offset      = input.int(80, minval = 0, maxval = 2000, title='Offset (%)', group = 'Shape & Offset')

// Calibration Values (من بيانات السوق السعودي)
// هذه القيم محسوبة يومياً من recalculate_rs.py
// آخر تحديث: يتم تحديثها تلقائياً كل يوم
allowReplay = input(true, title = 'Use Calibrated Thresholds', group ='Saudi Market Calibration')
first2      = input(99.00, title='For 99 Rating (Top 1%)', group = 'Saudi Market Calibration', tooltip='Stocks with RS Score >= this get rating 99')
scnd2       = input(85.00, title='For 90+ Rating (Top 10%)', group = 'Saudi Market Calibration')
thrd2       = input(67.40, title='For 70+ Rating', group = 'Saudi Market Calibration')
frth2       = input(52.00, title='For 50+ Rating (Median)', group = 'Saudi Market Calibration')
ffth2       = input(35.00, title='For 30+ Rating', group = 'Saudi Market Calibration')
sxth2       = input(16.00, title='For 10+ Rating', group = 'Saudi Market Calibration')
svth2       = input(4.82, title='For 1 Rating (Bottom)', group = 'Saudi Market Calibration')

// MA Options
boolMa      = input(false, title = 'Display MA on RS Line', group = '1st MA on RS Line')
lenMa       = input(21, title = 'Length', group = '1st MA on RS Line')
colMa       = input(color.orange, title = 'Color', group = '1st MA on RS Line')
typMa       = input.string('EMA', title = 'Type', options = ['SMA', 'EMA'], group = '1st MA on RS Line')

// --- PERIOD DEFINITIONS ---
n63      = bar_index < 63  ? bar_index : 63 
n126     = bar_index < 126 ? bar_index : 126
n189     = bar_index < 189 ? bar_index : 189
n252     = bar_index < 252 ? bar_index : 252

// --- RS LINE CALCULATION ---
comparativeSymbol = request.security(lineTicker, timeframe.period, close)
rsCurve = (close / comparativeSymbol)
rsRatio = timeframe.isweekly ? IndexValue*(offset-10)/100 : IndexValue*offset/100
rs = rsCurve * rsRatio

rsPlot = plot(rs, title='RS Line', style=plot.style_line, linewidth=1, color=colorRS)

// MA
float rsMA = na
if boolMa
    if typMa == 'SMA'
        rsMA := ta.sma(rs, timeframe.isweekly ? 10 : lenMa)
    else
        rsMA := ta.ema(rs, timeframe.isweekly ? 10 : lenMa)
maPlot = plot(boolMa ? rsMA : na, color = colMa, linewidth = 1)

// --- RS SCORE CALCULATION ---
closeDa    = request.security(syminfo.tickerid, 'D', close)
spxCloseDa = request.security(comparativeTickerId, 'D', close)

// Stock Performance
safe_close_63  = nz(closeDa[n63], closeDa)
safe_close_126 = nz(closeDa[n126], closeDa)
safe_close_189 = nz(closeDa[n189], closeDa)
safe_close_252 = nz(closeDa[n252], closeDa)

perfTicker63   = closeDa / safe_close_63
perfTicker126  = closeDa / safe_close_126
perfTicker189  = closeDa / safe_close_189
perfTicker252  = closeDa / safe_close_252

// Index Performance
safe_idx_63  = nz(spxCloseDa[n63], spxCloseDa)
safe_idx_126 = nz(spxCloseDa[n126], spxCloseDa)
safe_idx_189 = nz(spxCloseDa[n189], spxCloseDa)
safe_idx_252 = nz(spxCloseDa[n252], spxCloseDa)

perfComp63     = spxCloseDa / safe_idx_63
perfComp126    = spxCloseDa / safe_idx_126
perfComp189    = spxCloseDa / safe_idx_189
perfComp252    = spxCloseDa / safe_idx_252

// Weighted RS Score
float rs_stock = 0.4*perfTicker63 + 0.2*perfTicker126 + 0.2*perfTicker189 + 0.2*perfTicker252
float rs_ref   = 0.4*perfComp63   + 0.2*perfComp126   + 0.2*perfComp189   + 0.2*perfComp252

float totalRsScore  = (rs_stock / rs_ref) * 100
float totalRsRating = -1

// --- PERCENTILE CONVERSION ---
// Using calibrated thresholds
float first = first2
float scnd  = scnd2 
float thrd  = thrd2 
float frth  = frth2 
float ffth  = ffth2 
float sxth  = sxth2 
float svth  = svth2 

// Boundary conditions
if(totalRsScore >= first)
    totalRsRating := 99
else if(totalRsScore <= svth)
    totalRsRating := 1
else
    // Linear interpolation between thresholds
    if (totalRsScore >= scnd)
        // Between first and scnd: 99 to 90
        totalRsRating := 90 + ((totalRsScore - scnd) / (first - scnd)) * 9
    else if (totalRsScore >= thrd)
        // Between scnd and thrd: 90 to 70
        totalRsRating := 70 + ((totalRsScore - thrd) / (scnd - thrd)) * 20
    else if (totalRsScore >= frth)
        // Between thrd and frth: 70 to 50
        totalRsRating := 50 + ((totalRsScore - frth) / (thrd - frth)) * 20
    else if (totalRsScore >= ffth)
        // Between frth and ffth: 50 to 30
        totalRsRating := 30 + ((totalRsScore - ffth) / (frth - ffth)) * 20
    else if (totalRsScore >= sxth)
        // Between ffth and sxth: 30 to 10
        totalRsRating := 10 + ((totalRsScore - sxth) / (ffth - sxth)) * 20
    else
        // Between sxth and svth: 10 to 1
        totalRsRating := 1 + ((totalRsScore - svth) / (sxth - svth)) * 9

// Round to integer
totalRsRating := math.round(totalRsRating)

// --- DISPLAY ---
isDaily = timeframe.isdaily
labelText1 = '     Saudi RS Rating'
labelText2 = ''

if (isDaily and totalRsRating != -1)
    labelText2 := '\n\n    ' + str.tostring(totalRsRating, '#0')
else if (not isDaily)
    labelText2 := '\n\n    Use Daily TF'

if (ratingOnly)
    labelText1 := ''
    labelText2 := '\n  ' + str.tostring(totalRsRating, '#0')

// Color based on rating
labelColor = totalRsRating >= 80 ? color.new(color.green, 80) : 
             totalRsRating >= 50 ? color.new(color.blue, 80) : 
             color.new(color.red, 80)

textColorVal = totalRsRating >= 80 ? color.green : 
               totalRsRating >= 50 ? color.blue : 
               color.red

if barstate.islast and not hideRSRat
    label.new(bar_index, rs, 
              text=labelText1 + labelText2, 
              color=labelColor, 
              style=label.style_label_left, 
              textcolor=textColorVal, 
              size=size.large)
