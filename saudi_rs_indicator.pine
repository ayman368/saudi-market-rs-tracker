//@version=5
indicator(title='Saudi RS Rating (TASI Comparison)', shorttitle='Saudi RS', overlay=true, max_bars_back = 253)

// --- CONFIGURATION ---
// Comparative Symbol (Saudi General Index)
comparativeTickerId = 'TADAWUL:TASI' 

// --- INPUTS ---
hideRSRat   = input(false, title='Hide Rating', group = 'RS Line')
ratingOnly  = input(false, title='Rating Only', group = 'RS Line')
colorRS     = input(color.rgb(0, 0, 255,0), title = 'Color', group = 'RS Line')
lineTicker  = input('TADAWUL:TASI', title='Comparative Symbol for Line', group = 'Shape & Offset', tooltip = 'Reference ticker used for calculation of the RS Line.')
IndexValue  = input(11500, title='Approximate Value of Index', group = 'Shape & Offset', tooltip = 'Used to gather a constant value for easier visual comparison')
offset      = input.int(80, minval = 0, maxval = 2000, title='Offset (%)', group = 'Shape & Offset', tooltip = 'Used to display the RS Line under the price.')

plotNewHigh = input(true, title = 'Plot RS New Highs', group = 'RS Line New High')
rsNewHigh   = input.string('RS New Highs', title = 'Type', options=['RS New Highs','RS New Highs Before Price', 'Historical RS New Highs', 'Historical RS New Highs  Before Price'], group = 'RS Line New High')
blueDotCol  = input(color.rgb(121, 213, 242,62), title = 'Color', group = 'RS Line New High')
lookback    = input.int(250, title = 'Look-back', minval = 1, maxval = 252, group = 'RS Line New High')
sizeLabHigh = input.string('Tiny', title = 'Size', options = ['Tiny', 'Small', 'Normal', 'Large'], group = 'RS Line New High')

plotNewLow  = input(false, title = 'Plot RS New Lows', group = 'RS Line New High')
rsNewLow    = input.string('Historical RS New Lows', title = 'Type', options=['RS New Lows','RS New Lows Before Price', 'Historical RS New Lows', 'Historical RS New Lows  Before Price'], group = 'RS Line New High')
redDotCol   = input(color.rgb(255, 82, 82, 62), title = 'Color', group = 'RS Line New High')
lookback2   = input.int(250, title = 'Look-back', minval = 1, maxval = 252, group = 'RS Line New High')
sizeLabLow  = input.string('Tiny', title = 'Size', options = ['Tiny', 'Small', 'Normal', 'Large'], group = 'RS Line New High')

// MA Inputs
boolMa      = input(false, title = 'Display MA 1 on RS Line', group = '1st MA on RS Line')
lenMa       = input(21, title = 'Length', group = '1st MA on RS Line')
colMa       = input(color.orange, title = 'Color', group = '1st MA on RS Line')
typMa       = input.string('EMA', title = 'Type', options = ['SMA', 'EMA'], group = '1st MA on RS Line')

boolMa2     = input(false, title = 'Display MA 2 on RS Line', group = '2nd MA on RS Line')
lenMa2      = input(50, title = 'Length', group = '2nd MA on RS Line')
colMa2      = input(color.red, title = 'Color', group = '2nd MA on RS Line')
typMa2      = input.string('EMA', title = 'Type', options = ['SMA', 'EMA'], group = '2nd MA on RS Line')

// --- LOGIC ---

// Handle Weekly Lookback
if (lookback  == 250 and timeframe.isweekly)
    lookback  := 52
if (lookback2 == 250 and timeframe.isweekly)
    lookback2 := 52

// Label Size
highLabel = switch sizeLabHigh
    'Normal'  => size.normal
    'Tiny'    => size.tiny
    'Small'   => size.small
    'Large'   => size.large

lowLabel  = switch sizeLabLow
    'Normal'  => size.normal
    'Tiny'    => size.tiny
    'Small'   => size.small
    'Large'   => size.large

// --- RS LINE CALCULATION ---
comparativeSymbol   = request.security(lineTicker, timeframe.period, close)
// RS Ratio = Stock / Index
rsCurve             = (close / comparativeSymbol)

// Scaling for display
if (syminfo.industry == 'Investment Trusts/Mutual Funds')
    offset := 90

// Adjust for weekly
rsRatio             = timeframe.isweekly ? IndexValue*(offset-10)/100 : IndexValue*offset/100
rs                  = rsCurve * rsRatio

prevlookback  = lookback
prevlookback2 = lookback2 
lookback := math.min(lookback - 1, bar_index)

rsPlot = plot(rs, title='RS Line', style=plot.style_line, linewidth=1, color=colorRS)

// --- MOVING AVERAGES ---
// MA 1
float rsMA = na
if boolMa
    if typMa == 'SMA'
        rsMA := ta.sma(rs, timeframe.isweekly ? 10 : lenMa)
    else
        rsMA := ta.ema(rs, timeframe.isweekly ? 10 : lenMa)
maPlot = plot(boolMa ? rsMA : na, color = colMa, linewidth = 1)

// MA 2
float rsMA2 = na
if boolMa2
    if typMa2 == 'SMA'
        rsMA2 := ta.sma(rs, timeframe.isweekly ? 21 : lenMa2)
    else
        rsMA2 := ta.ema(rs, timeframe.isweekly ? 21 : lenMa2)
maPlot3 = plot(boolMa2 ? rsMA2 : na, color = colMa2, linewidth = 1)


// --- NEW HIGHS / LOWS DOTS ---
histNH = ta.highest(rs, prevlookback)
histCl = ta.highest(high, prevlookback)

// Logic for Highs
if (plotNewHigh)
    bool isHigh = (rs == histNH)
    bool isBeforePrice = (high < histCl)
    
    if (rsNewHigh == 'Historical RS New Highs' and isHigh)
        label.new(x = bar_index, y = rs, color = blueDotCol, style = label.style_circle, size = highLabel)
    else if (rsNewHigh == 'Historical RS New Highs  Before Price' and isHigh and isBeforePrice)
        label.new(x = bar_index, y = rs, color = blueDotCol, style = label.style_circle, size = highLabel)
    
    // Recent only (delete old)
    // Note: In Pine 5 'var label' allows updating just one label for current bar
    // simplified here for overlay

// --- RS SCORE CALCULATION (Weighted) ---
// Based on MarketSmith/IBD Formula: 
// 40% * 3M + 20% * 6M + 20% * 9M + 20% * 12M

n63      = 63 
n126     = 126
n189     = 189
n252     = 252

// Get Daily Closes
closeDa    = request.security(syminfo.tickerid, 'D', close)
spxCloseDa = request.security(comparativeTickerId, 'D', close)

// Calculate Performance
// Prevent error if not enough history
safe_close = closeDa
safe_close_63  = nz(closeDa[n63], closeDa)
safe_close_126 = nz(closeDa[n126], closeDa)
safe_close_189 = nz(closeDa[n189], closeDa)
safe_close_252 = nz(closeDa[n252], closeDa)

perfTicker63   = safe_close / safe_close_63
perfTicker126  = safe_close / safe_close_126
perfTicker189  = safe_close / safe_close_189
perfTicker252  = safe_close / safe_close_252

// Index Performance
safe_idx = spxCloseDa
safe_idx_63  = nz(spxCloseDa[n63], spxCloseDa)
safe_idx_126 = nz(spxCloseDa[n126], spxCloseDa)
safe_idx_189 = nz(spxCloseDa[n189], spxCloseDa)
safe_idx_252 = nz(spxCloseDa[n252], spxCloseDa)

perfComp63     = safe_idx / safe_idx_63
perfComp126    = safe_idx / safe_idx_126
perfComp189    = safe_idx / safe_idx_189
perfComp252    = safe_idx / safe_idx_252

// Weighted Sums
// 3M (63 days) gets 40% weight (0.4)
float rs_stock = 0.4*perfTicker63 + 0.2*perfTicker126 + 0.2*perfTicker189 + 0.2*perfTicker252
float rs_ref   = 0.4*perfComp63   + 0.2*perfComp126   + 0.2*perfComp189   + 0.2*perfComp252

// Relative Score
// A score of 100 means performed exactly same as Index. >100 Outperformed.
float totalRsScore  = (rs_stock / rs_ref) * 100

// --- DISPLAY RATING ---
// Note: True Period Rank (1-99) is impossible in standalone Pine Script 
// without an external database of all stock scores for the day.
// However, we can display the "Raw Score" which is accurate.
// Or we can use a "Replay/Approximation" map if you calibrated it.
// Defaulting to displaying the Raw Score relative to TASI.

// Approximations for Saudi Market (Example - Need calibration)
// These thresholds mimic the distribution of strong stocks.
// You can adjust 'first', 'scnd', etc in the inputs if you want to fake a 1-99 rating.
first = 130.0 // Top 1% approx
scnd  = 120.0 // Top 10%
svth  = 80.0  // Bottom 10%

float totalRsRating = totalRsScore // Default to raw score if no rank possible

// Display Label
labelText = 'RS Score: ' + str.tostring(totalRsScore, '#.##')
labelColor = color.rgb(0,0,0,100)
textColor = totalRsScore > 100 ? color.green : color.red

if barstate.islast and not hideRSRat
    label.new(bar_index, rs, text=labelText, color=labelColor, style=label.style_label_left, textcolor=textColor, size=size.normal)

